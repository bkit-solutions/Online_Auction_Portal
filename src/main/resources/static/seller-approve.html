<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Seller Quote Approval</title>
  <style>
	body {
	      font-family: 'Segoe UI', sans-serif;
	      background-color: #f0f2f5;
	      margin: 0;
	      padding: 40px;
	      display: flex;
	      flex-direction: column;
	      align-items: center;
	    }
	
	    .dashboard-container {
	      background-color: #fff;
	      padding: 30px 40px;
	      border-radius: 12px;
	      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
	      width: 100%;
	      max-width: 800px;
	    }
	
	    .top-bar {
	      display: flex;
	      justify-content: space-between;
	      align-items: center;
	      margin-bottom: 20px;
	    }
	
	    .top-bar h2 {
	      margin: 0;
	      color: #2c3e50;
	    }
	
	    .top-bar button {
	      background-color: #007bff;
	      color: white;
	      border: none;
	      padding: 10px 16px;
	      border-radius: 8px;
	      font-size: 14px;
	      cursor: pointer;
	    }
	
	    .top-bar button:hover {
	      background-color: #0056b3;
	    }
	
	    h3 {
	      color: #333;
	      margin-bottom: 16px;
	    }
	
	    input, textarea, select {
	      width: 100%;
	      padding: 12px;
	      margin-bottom: 16px;
	      border: 1px solid #ccc;
	      border-radius: 8px;
	      font-size: 16px;
	    }
	
	    button {
	      width: 100%;
	      padding: 12px;
	      background-color: #28a745;
	      color: white;
	      font-weight: bold;
	      font-size: 16px;
	      border: none;
	      border-radius: 8px;
	      cursor: pointer;
	    }
	
	    button:hover {
	      background-color: #218838;
	    }
	
	    #uploadMessage {
	      font-weight: 500;
	      margin-top: 10px;
	    }
	
	    .error {
	      color: #e74c3c;
	    }
	
	    .product {
	      background-color: #fafafa;
	      border: 1px solid #ddd;
	      border-radius: 8px;
	      padding: 16px;
	      margin-top: 20px;
	    }
	
	    .product img {
	      width: 100px;
	      border-radius: 6px;
	      margin-top: 10px;
	    }
  </style>
</head>
<body>
  <h2>Seller Approval Dashboard</h2>
  <div id="productList">Loading products...</div>
  <p id="errorMsg" class="error"></p>
  <button class="logout-btn" onclick="logout()">Logout</button>

  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    const sellerId = user?.id;

    if (!sellerId) {
      document.getElementById("productList").innerHTML = '<p class="error">Seller not logged in.</p>';
      throw new Error("Seller not found in localStorage");
    }
	function logout() {
		     // Clear session/localStorage if needed
		     // localStorage.clear();
		
		     // Redirect to login page
		     window.location.href = "login.html";
		   }

    async function fetchSellerProducts() {
      try {
        const res = await fetch(`http://localhost:8080/api/products/seller/${sellerId}`);
        const products = await res.json();
        const container = document.getElementById("productList");
        container.innerHTML = "";

        if (!Array.isArray(products) || products.length === 0) {
          container.innerHTML = "<p>No products found for this seller.</p>";
          return;
        }

        for (const product of products) {
          const auctionRes = await fetch(`http://localhost:8080/api/auctions/product/${product.id}`);
          const auction = await auctionRes.json();

          let quotes = [];
          if (auction?.id) {
            const quoteRes = await fetch(`http://localhost:8080/api/quotes/auction/${auction.id}`);
            quotes = await quoteRes.json();
          }

          const div = document.createElement("div");
          div.className = "product";

          let quoteHTML = `<p>No quotes yet.</p>`;
          let highest = null;

          if (quotes.length > 0) {
            highest = quotes.reduce((max, q) => (q.price ?? q.amount ?? 0) > (max.price ?? max.amount ?? 0) ? q : max, quotes[0]);

            quoteHTML = quotes.map(q => {
              const price = q.price ?? q.amount ?? 'N/A';
              const buyerId = q.buyer?.id ?? q.buyerId ?? 'N/A';
              return `
                <div class="quote ${q.id === highest.id ? 'highest' : ''}">
                  ₹${price} by Buyer #${buyerId}
                </div>
              `;
            }).join("");
          }

          div.innerHTML = `
            <strong>${product.name}</strong><br/>
            Base Price: ₹${product.basePrice}<br/>
            <p>${product.description}</p>
            <img src="http://localhost:8080/uploads/${product.imagePath}" alt="${product.name}" />
            <div>${quoteHTML}</div>
            ${highest ? `<button onclick="approveQuote(${auction.id})">Approve Highest Quote</button>` : ''}
          `;
          container.appendChild(div);
        }

      } catch (err) {
        console.error("Error loading products:", err);
        document.getElementById("errorMsg").innerText = "Failed to load products.";
      }
    }

    async function approveQuote(auctionId) {
      try {
        const res = await fetch(`http://localhost:8080/api/quotes/approve/${auctionId}`, {
          method: "POST"
        });
        const msg = await res.text();
        alert(msg);
        fetchSellerProducts(); // Refresh after approval
      } catch (err) {
        alert("Error approving quote: " + err.message);
      }
    }

    window.onload = fetchSellerProducts;
  </script>
</body>
</html>
